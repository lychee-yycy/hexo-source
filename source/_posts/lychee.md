---
title: Lychee简介
date: 2023/07/27 17:22:25
comments: true
toc: true
tags:
  - linux Desktop Environment
categories:
  - Linux-Lychee桌面
---

## 简介
&nbsp;&nbsp;&nbsp;&nbsp;什么是Lyche？这是笔者准备打造的一个Linux桌面环境。Linux操作系统一般是由Linux内核、GNU软件、桌面环境组成，当只有内核和GUN软件时，可能用户的功能就被限制在tty界面，这是最基础的图形交互，以命令的形式操控计算机硬件执行各种任务。想在这种模式下熟练的使用计算机，用户需要丰富的shell命令知识和熟悉大量地GUN组件。那能否在Linux上实现方便的图形UI交互呢？比如滑动滑块、点击按钮、滚动视图？当然可以，此时需要引入X和Wayland图形框架，其作为操作系统的显示服务器协议，它的作用是管理图形界面的显示和输入。显示服务协议可以实现Server/Client一对多的模式，从而可以实现多个窗口在显示器上工作且被管理的井井有条。
&nbsp;&nbsp;&nbsp;&nbsp;笔者也是在了解wlroots（一个基于libwayland打造的库）原理后，基于其设计和编写了一套桌面显示框架，主要的目标是实现轻量型的全面GPU硬件加速图形架构，保证桌面高效、快捷地运行。基于wlroots打造的合成器命名为wsm（wayland surface manager），桌面会采用移动终端设备的开发思维来制作，从而同时支持PC设备、手机和平板等终端设备，为了实现这一特点，底层和中间层采用C语言和Qt/C++编写，上层UI界面采用Qt/Quick、QML制作，以实现高运行能效和方便快捷的多指触控交互。笔者以荔枝命名这个桌面环境象征了多种积极的含义：
- 美味与丰富：荔枝是一种甜美可口的水果，它可以代表丰富、多样化和愉悦的体验。暗示用户使用Lychee将会享受到风多样的功能和愉悦的使用体验。
- 独特与珍贵：荔枝在某些地区是一种稀有的水果，其独特的外观和口感使其备受珍视。可以传达它的独特性和珍贵性，让用户感到他们正在使用一种特别的系统。
- 多重层次：荔枝的外皮纹理和内部果肉层次分明，这可以象征操作系统的复杂性和深度。暗示系统具有丰富的功能和多层次的操作体验。
- 联系和共享：荔枝通常以簇状结构生长，多个过世聚集在一起。这可以象征着联系和共享，表达操作系统连接人们、促进信息共享和协作的特性。
![1.1 lychee形象图-彩色](/img/lychee/lychee.svg)
&nbsp;&nbsp;&nbsp;&nbsp;总的来説，荔枝可以代表美味、独特、多重层次和联系，这些寓意可以为操作系统带来积极的形象和用户体验。本文描述的所有模块均是在Arch Linux平台上开发实现，其中上层代码采用Qt6制作，lychee-workspace作为Session manager和桌面环境项目是依赖显示管理器的的，笔者使用的显示管理器是sddm-git,其在wayland环境下更加稳定可靠。

## 桌面组件
&nbsp;&nbsp;&nbsp;&nbsp;在Linux桌面环境中，桌面组件是指在桌面上显示的各种图形化元素和小工具，用于增强用户体验和提供快速访问常用功能。不同的桌面环境会提供不同的桌面组件，以下是一些常见的Linux桌面组件介绍：
- 桌面图标：桌面图标是文件、文件夹、应用程序或链接的缩略图，通过点击这些图标可以打开相应的项目。
- 面板/任务栏：面板通常位于屏幕的底部或顶部，它包含了启动器（Launcher）、任务栏（Taskbar）和系统托盘（System tray）。启动器用于快速启动应用程序，任务栏显示当前运行的应用程序，而系统托盘显示了一些后台运行的图标和通知，比如网络连接、音量控制、电池状态等。
- 窗口管理器：窗口管理器控制着窗口的外观和行为，包括窗口的移动、缩放、最大化、最小化等。常见的窗口管理器有：Kwin（KDE Plasma的窗口管理器）、Mutter（GNOME的窗口管理器）、Compiz等。
- 小工具/小部件：小工具是一些小型应用程序或实用工具，它们可以嵌入到桌面上，比如天气预报、日历、时钟、笔记等。
- 桌面壁纸：桌面壁纸是显示在桌面背景上的图像或图片，用于装饰桌面。
- 文件管理器：文件管理器是用来浏览、管理文件和文件夹的工具，它允许用户在文件系统中进行复制、粘贴、删除、移动等操作。
- 快捷方式/图标：快捷方式或图标是指一些特殊的图标，它们代表着应用程序、文件夹或网址的链接，方便用户快速访问。
- 系统监视器：系统监视器是用来显示系统资源使用情况的小工具，包括CPU使用率、内存占用、网络流量等信息。
- 终端：终端是Linux中一个重要的工具，允许用户通过命令行界面与系统进行交互和管理。
- 任务切换器：任务切换器用于在多个运行中的应用程序之间切换，让用户轻松切换焦点。
- 启动器：启动器通常位于桌面面板或任务栏上，它包含了图标或按钮，代表着已安装的应用程序。通过点击启动器上的应用程序图标，用户可以快速启动相应的应用程序，而无需通过终端或文件管理器来找到应用的可执行文件。
- 锁屏/登陆：锁屏/登录需要输入有效的用户名和密码才能成功进入桌面。这是确保只有授权用户能够访问计算机的基本安全措施之一。同时也是多任务切换的图形交互入口。
- 通知中心：用于显示系统和应用程序通知的集中管理器。它的作用在于改善用户体验，提供非侵入性的通知，并确保重要信息不会被错过。
- 设置：允许用户对操作系统的各种设置进行配置和调整。包括用户设置、蓝牙设置、网络设置、声音设置、显示设置等。
- 工作区：管理多桌面工作，允许用户添加虚拟桌面。
桌面也是操作系统中非常核心的部分，因为文字限制笔者只介绍其中一部分内容。

### wsm
&nbsp;&nbsp;&nbsp;&nbsp;wsm是一个构建图形用户界面的Wayland合成器栈，它旨在提供更简洁、更现代、更安全的方式来处理图形显示和用户输入，以提供更好的性能和易于扩展的定制化功能。wsm引用wlroots完成wayland基础功能，并在其之上扩展了输入管理和渲染增强。在架构上实现合成器和桌面环境低耦合是wsm的诚意，在功能上支持触摸屏手势和高性能、质量地特效混成是wsm追求的目标，以下是wlroots和wsm相关技术堆栈的介绍：
![2.1 wlroots框架图](/img/lychee/wlroots.svg)
![2.2 wsm框架图](/img/lychee/wsm.svg)
&nbsp;&nbsp;&nbsp;&nbsp;wsm在设计之初定位是一个纯粹的wayland合成器，其不包含任何xwayland的代码。但随着开发的深入，功能逐渐健壮，最近笔者试着引入一个xwayland的meson构建选项，以便后续可以构建出在wayland下支持x11应用程序运行的wsm版本。这并非笔者的本意，为了生态过渡地兼容是一场扼杀操作系统于无形的灾难，笔者想打造的是高性能图形显示和流畅的用户交互而非功能最全的桌面环境，在未来的计划里lychee-pc（电脑版本的lychee）和lychee-mobile（手机、平板版本的lychee）会采用同一种技术方案构建，所以xwayland的选项仅仅只是一个体验选项，其并非lychee的核心设计，xwayland选项控制代码如下：
```meson
option('xwayland', description: 'Enable support for X11 applications', type: 'feature', value: 'auto')
```

### lychee-wallpaper
&nbsp;&nbsp;&nbsp;&nbsp;壁纸引擎是lychee桌面的一个特色，目前规划有墙纸、动态壁纸、视频壁纸等三种，其分别对应图片显示、着色器渲染图像带触控交互、视频播放。后续可能推出转场壁纸功能，可以实现特定动作出发壁纸动态更形转场显示。壁纸相关框架图如下：
![2.3 wallpaper框架图](/img/lychee/Lychee-wallpaper.svg)

### lychee-workspace

## 总结
&nbsp;&nbsp;&nbsp;&nbsp;lychee是一个集大成地桌面环境，它不仅包括桌面环境模块、wayland合成器、壁纸、后端管理、网络栈、蓝牙栈、声音栈、系统生态软件、系统通知，还有笔者想要套索的xdg桌面规范，目前市场上没有任何一家基于linux的操作系统完整的符合xdg桌面规范，也许这个规范并不完善，但是应当用于尝试，走的人多了路就形成了，笔者对开源的态度是它提供了一个基础的能力给你，而开发人员最好在开源的限制和框架下最大化的扩展和完善其功能从而满足自己的产品设计，然后将其中的扩展部分适当的反馈和提交到上游开源组织，从而形成一个良性的循环。如此反复才能形成一个大家都会遵守且符合功能xdg桌面标准。
&nbsp;&nbsp;&nbsp;&nbsp;系统通知是基于D-Bus（Desktop Bus）协议，目前的技术框架要求应用程序在最小化之后必须保持后台活跃，当应用程序收到新的消息时，通过调用dbus接口，向系统中的通知服务进程发送信息，系统通知服务进程将该消息以UI的方式展示在屏幕上从而通知用户。这种框架在各种工况下都有短板，例如：
- dbus可以被第三方应用程序捕获，这样的话，病毒可以轻易的窃取到用户系统通知转存分析，这对系统安全是一个严重的

## 参考资料
- [Xorg  -open source implementation of the X Window System](https://www.freedesktop.org/wiki/)
- [Wayland -specifies the communication between a display server and its clients](https://wayland.freedesktop.org/)
- [wlroots -modular Wayland compositor library](https://gitlab.freedesktop.org/wlroots)